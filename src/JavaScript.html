<script>
  /**
   * Jalankan fungsi sebaik sahaja aplikasi dibuka
   */
  document.addEventListener('DOMContentLoaded', function() {
    loadPosts(); // Muat naik post pertama kali
    
    // AUTO-REFRESH: Semak post baru setiap 5 saat (5000ms)
    setInterval(loadPosts, 5000); 
  });

  /**
   * Mengambil data post daripada Google Sheets melalui Code.gs
   */
  function loadPosts() {
    google.script.run
      .withSuccessHandler(renderPosts)
      .getPosts();
  }

  /**
   * Memaparkan data post ke dalam HTML
   */
  function renderPosts(posts) {
    const container = document.getElementById('feed-container');
    
    if (!posts || posts.length === 0) {
      container.innerHTML = '<div class="text-center py-5 text-muted small">Belum ada perkongsian lagi. Jadi yang pertama!</div>';
      return;
    }

    // Map data Sheets ke dalam format HTML moden
    const html = posts.map(post => `
      <div class="thread-card">
        <div class="d-flex">
          <div class="profile-pic"></div>
          <div class="flex-grow-1">
            <div class="d-flex align-items-baseline">
              <span class="username">${post[1]}</span>
              <span class="timestamp">${formatTimeAgo(post[0])}</span>
            </div>
            <div class="post-content">${post[2]}</div>
          </div>
        </div>
      </div>
    `).join('');

    container.innerHTML = html;
  }

  /**
   * Menguruskan penghantaran post baru
   */
  function handlePostSubmit() {
    const userInput = document.getElementById('username');
    const contentInput = document.getElementById('content');
    const btn = document.getElementById('postBtn');

    const user = userInput.value.trim();
    const text = contentInput.value.trim();

    if (!user || !text) {
      alert("Sila isi nama dan luahan anda.");
      return;
    }

    // Kunci butang supaya tidak hantar dua kali
    btn.disabled = true;
    btn.innerText = "Posting...";

    google.script.run
      .withSuccessHandler(function() {
        // Kosongkan ruangan menulis sahaja, nama dikekalkan untuk memudahkan user
        contentInput.value = ""; 
        btn.disabled = false;
        btn.innerText = "Post";
        loadPosts(); // Muat semula dinding serta-merta
      })
      .submitPost(user, text);
  }

  /**
   * Menukar format tarikh kepada format yang lebih mesra (Masa · Tarikh)
   */
  function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return ""; // Elakkan error jika tarikh tidak sah

    const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const day = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    
    return `${time} · ${day}`;
  }
</script>
